name: Publish npm packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: |
          retry_with_backoff() {
            local max_attempts=$1; shift
            local delay=$1; shift
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: $*"
              if "$@"; then
                return 0
              fi
              if [ $attempt -eq $max_attempts ]; then
                echo "All $max_attempts attempts failed"
                return 1
              fi
              echo "Waiting ${delay}s before retry..."
              sleep $delay
              delay=$((delay * 2))
              attempt=$((attempt + 1))
            done
          }
          retry_with_backoff 3 5 npm ci

      - run: npm run build

      - name: Publish and verify packages
        run: |
          retry_with_backoff() {
            local max_attempts=$1; shift
            local delay=$1; shift
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: $*"
              if "$@"; then
                return 0
              fi
              if [ $attempt -eq $max_attempts ]; then
                echo "All $max_attempts attempts failed"
                return 1
              fi
              echo "Waiting ${delay}s before retry..."
              sleep $delay
              delay=$((delay * 2))
              attempt=$((attempt + 1))
            done
          }

          publish_package() {
            local pkg=$1
            local name version published
            name=$(node -p "require('./${pkg}package.json').name")
            version=$(node -p "require('./${pkg}package.json').version")
            published=$(npm view "$name@$version" version 2>/dev/null || echo "")
            if [ "$published" = "$version" ]; then
              echo "Skipping $name@$version (already published)"
              return 0
            fi
            echo "Publishing $name@$version"
            retry_with_backoff 5 10 npm publish --workspace "$pkg"
            echo "$name@$version" >> "$NEWLY_PUBLISHED"
          }

          verify_published() {
            if [ ! -s "$NEWLY_PUBLISHED" ]; then
              echo "No new packages to verify"
              return 0
            fi
            local failures=0
            while IFS= read -r entry; do
              local name="${entry%@*}"
              local version="${entry##*@}"
              echo "Verifying $name@$version is available on registry..."
              local attempt=1 max_attempts=10 delay=5
              local found=false
              while [ $attempt -le $max_attempts ]; do
                if [ "$(npm view "$name@$version" version 2>/dev/null || echo "")" = "$version" ]; then
                  echo "Confirmed $name@$version is available"
                  found=true
                  break
                fi
                echo "Not yet available (attempt $attempt/$max_attempts), waiting ${delay}s..."
                sleep $delay
                delay=$((delay * 2))
                if [ $delay -gt 60 ]; then delay=60; fi
                attempt=$((attempt + 1))
              done
              if [ "$found" = false ]; then
                echo "ERROR: $name@$version not available after $max_attempts attempts"
                failures=$((failures + 1))
              fi
            done < "$NEWLY_PUBLISHED"
            if [ $failures -gt 0 ]; then
              echo "ERROR: $failures package(s) failed verification"
              return 1
            fi
            echo "All packages verified available"
          }

          NEWLY_PUBLISHED=$(mktemp)
          export NEWLY_PUBLISHED

          for pkg in packages/*/; do
            publish_package "$pkg"
          done

          verify_published
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  dispatch:
    name: Trigger docs-builder image rebuild
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch rebuild-image to docs-builder
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh api repos/f5xc-salesdemos/docs-builder/dispatches \
            --method POST \
            --field event_type=rebuild-image
